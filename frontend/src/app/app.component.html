<div class="container">
    <header>
        <h1>ü•• <span>Coconut Yield Predictor: Parthiban AI</span></h1>
        <p class="subtitle">Mission: Pure Mathematical Education & Agricultural Analytics</p>

        <div class="math-hero-section fadeIn">
            <div class="math-card-grid">
                <div class="math-mini-card">
                    <span class="math-icon">üìê</span>
                    <h4>Linear Algebra</h4>
                    <p>Vectorized Dot Products ($Xw + b$)</p>
                </div>
                <div class="math-mini-card">
                    <span class="math-icon">üìâ</span>
                    <h4>Calculus</h4>
                    <p>Partial Derivatives & Gradients</p>
                </div>
                <div class="math-mini-card">
                    <span class="math-icon">üìä</span>
                    <h4>Statistics</h4>
                    <p>Z-Score Scaling & R¬≤ Variance</p>
                </div>
                <div class="math-mini-card">
                    <span class="math-icon">‚öôÔ∏è</span>
                    <h4>Optimization</h4>
                    <p>Gradient Descent (3,000 steps)</p>
                </div>
            </div>
            <div class="edu-notice">
                üìö <strong>Education Notice:</strong> This project is built <strong>from scratch</strong> (no ML
                libraries) to demonstrate the raw mathematical mechanics of AI for educational purposes.
            </div>
        </div>
    </header>

    <main>
        <div class="tabs">
            <button (click)="selectTab('predict')" [class.active]="activeTab === 'predict'">Prediction</button>
            <button (click)="selectTab('data')" [class.active]="activeTab === 'data'">Data Science</button>
        </div>

        <!-- PREDICTION TAB -->
        <div *ngIf="activeTab === 'predict'" class="tab-content fadeIn">
            <div class="card input-section">
                <div class="card-header">
                    <h2>Enter Farm Details</h2>
                    <span class="badge">AI Model Ready</span>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="area">Farm Area (Hectares) <span class="required">*</span></label>
                        <input type="number" id="area" [(ngModel)]="area" placeholder="e.g. 50">
                    </div>

                    <div class="form-group">
                        <label for="year">Crop Year <span class="optional">(Optional)</span></label>
                        <input type="number" id="year" [(ngModel)]="year" placeholder="e.g. 2024">
                        <small>Defaults to historical average if blank</small>
                    </div>
                </div>

                <button (click)="predict()" [disabled]="!area || loading" class="predict-button">
                    <span *ngIf="!loading">Predict Yield</span>
                    <span *ngIf="loading">Calculating...</span>
                </button>
            </div>

            <div *ngIf="result" class="card result-section fadeIn">
                <h2>Prediction Result</h2>
                <div class="result-value">
                    <span class="value">{{ result.predicted_production | number:'1.0-0' }}</span>
                    <span class="unit">Coconuts</span>
                </div>

                <!-- Context Plot -->
                <div class="chart-container" *ngIf="result.context_plot">
                    <h3>Contextual Analysis</h3>
                    <img [src]="result.context_plot" alt="Prediction Context Graph" class="context-graph">
                    <p class="description chart-caption">The red dot represents your predicted yield compared to
                        historical trends.</p>
                </div>

                <!-- Math Explanation -->
                <div class="math-explanation" *ngIf="result.explanation">
                    <h3>How the AI Calculated This:</h3>
                    <ul>
                        <li><strong>Step 1 (Scaling):</strong> {{ result.explanation.step1_scaling }}</li>
                        <li><strong>Step 2 (Linear Eq):</strong> {{ result.explanation.step2_prediction }}</li>
                        <li><strong>Step 3 (Raw Result):</strong> {{ result.explanation.step3_result }}</li>
                        <li><strong>Step 4 (Final Yield):</strong> {{ result.explanation.step4_inverse }}</li>
                    </ul>
                </div>

                <!-- Historical Check (New Feature) -->
                <div class="historical-check" *ngIf="result.historical_match"
                    style="background: #ecfdf5; border: 1px solid #10b981; padding: 1rem; border-radius: 10px; margin-top: 1rem; text-align: left;">
                    <h3 style="color: #047857; margin-top: 0;">Historical Reality Check</h3>
                    <p style="margin-bottom: 0.5rem;">
                        We found an exact match in our records for <strong>{{ result.historical_match.state }}</strong>!
                    </p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <div>
                            <span style="display: block; font-size: 0.8rem; color: #6b7280;">AI Prediction</span>
                            <strong style="color: #db2777; font-size: 1.2rem;">{{ result.predicted_production |
                                number:'1.0-0' }}</strong>
                        </div>
                        <div style="font-weight: bold; color: #9ca3af;">VS</div>
                        <div>
                            <span style="display: block; font-size: 0.8rem; color: #6b7280;">Actual History</span>
                            <strong style="color: #059669; font-size: 1.2rem;">{{ result.historical_match.production |
                                number:'1.0-0' }}</strong>
                        </div>
                    </div>
                    <p style="font-size: 0.8rem; color: #6b7280; margin-top: 10px;">
                        * The difference is because the AI model generalizes across ALL states, whereas this record is
                        specific to {{ result.historical_match.district }}.
                    </p>
                </div>

                <div class="result-details">
                    <p><strong>Farm Size:</strong> {{ result.input.area }} Hectares</p>
                    <p><strong>Year:</strong> {{ result.input.year | number:'1.0-0' }}</p>
                </div>

                <div class="disclaimer" style="margin-top: 1.5rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                    <small style="color: #6b7280; font-style: italic;">
                        <strong>Note on Accuracy:</strong> This is a generic AI prediction based only on Area and Year
                        trends.
                        It does not account for specific "State" or "District" conditions (like soil or weather),
                        so the result may differ from specific historical records (e.g., Andaman vs Kerala yields differ
                        greatly).
                    </small>
                </div>

                <!-- ADDED: Model Intelligence & Reference Data (The "Data Science" info) -->
                <div class="model-intelligence-section"
                    style="margin-top: 3rem; border-top: 2px dashed #e5e7eb; padding-top: 2rem;">
                    <h2 style="color: #4b5563; font-size: 1.5rem; margin-bottom: 0.5rem;">Model Reference Context</h2>
                    <p style="color: #6b7280; margin-bottom: 2rem;">The table and charts below show the real-world
                        samples and math logic that the AI used to calculate your prediction.</p>

                    <!-- Dataset Table -->
                    <div class="table-responsive" *ngIf="dataInsight" style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 1rem;">Sample Training Data (Head 5)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>State</th>
                                    <th>District</th>
                                    <th>Year</th>
                                    <th>Area</th>
                                    <th>Production</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let row of dataInsight.head">
                                    <td>{{ row.State_Name }}</td>
                                    <td>{{ row.District_Name }}</td>
                                    <td>{{ row.Crop_Year }}</td>
                                    <td>{{ row.Area }}</td>
                                    <td>{{ row.Production }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Diagnostics Grid -->
                    <div class="diagnostic-grid" *ngIf="dataInsight"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                        <!-- Plot 1: Show Personalized global view if available, otherwise static -->
                        <div class="chart-container" *ngIf="result?.global_context_plot || dataInsight.plot_image">
                            <h3 style="font-size: 1rem;">Plot 1: Nation-wide Context</h3>
                            <img [src]="result?.global_context_plot || dataInsight.plot_image" alt="Regression Plot"
                                style="max-height: 200px; width: auto;">
                            <p class="description chart-caption" *ngIf="result?.global_context_plot">The Red Dot is YOUR
                                prediction on the national map.</p>
                        </div>
                        <div class="chart-container" *ngIf="dataInsight.cost_plot">
                            <h3 style="font-size: 1rem;">Learning Progress</h3>
                            <img [src]="dataInsight.cost_plot" alt="Cost History"
                                style="max-height: 200px; width: auto;">
                        </div>
                        <div class="chart-container" *ngIf="dataInsight.residual_plot">
                            <h3 style="font-size: 1rem;">Error Analysis</h3>
                            <img [src]="dataInsight.residual_plot" alt="Residuals"
                                style="max-height: 200px; width: auto;">
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="error" class="error-message">
                {{ error }}
            </div>
        </div>

        <!-- DATA SCIENCE TAB -->
        <div *ngIf="activeTab === 'data'" class="tab-content fadeIn">
            <div class="card data-section">
                <h2>Dataset Preview (Head 5)</h2>
                <p class="description">A glimpse into the training data used for the Linear Regression model.</p>

                <div class="table-responsive" *ngIf="dataInsight">
                    <table>
                        <thead>
                            <tr>
                                <th>State Name</th>
                                <th>District Name</th>
                                <th>Crop Year</th>
                                <th>Area</th>
                                <th>Production</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let row of dataInsight.head">
                                <td>{{ row.State_Name }}</td>
                                <td>{{ row.District_Name }}</td>
                                <td>{{ row.Crop_Year }}</td>
                                <td>{{ row.Area }}</td>
                                <td>{{ row.Production }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div *ngIf="!dataInsight && !dataLoading && !dataError">
                    <p>Loading data automatically...</p>
                </div>
                <div *ngIf="dataLoading">Loading Analysis...</div>
                <div *ngIf="dataError" class="error-message">{{ dataError }}</div>

                <div class="diagnostic-grid" *ngIf="dataInsight"
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                    <div class="chart-container" *ngIf="dataInsight.plot_image">
                        <h3>Plot 1: Regression Analysis</h3>
                        <img [src]="dataInsight.plot_image" alt="Regression Plot">
                        <p class="description chart-caption">AI "Best Fit" line across test data points.</p>
                    </div>
                    <div class="chart-container" *ngIf="dataInsight.cost_plot">
                        <h3>Plot 2: Optimization History</h3>
                        <img [src]="dataInsight.cost_plot" alt="Cost History">
                        <p class="description chart-caption">Cost (MSE Error) reducing over 3000 iterations.</p>
                    </div>
                    <div class="chart-container" *ngIf="dataInsight.residual_plot">
                        <h3>Plot 3: Residual Analysis</h3>
                        <img [src]="dataInsight.residual_plot" alt="Residuals">
                        <p class="description chart-caption">Distribution of errors (Should be Bell-shaped/Gaussian).
                        </p>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>